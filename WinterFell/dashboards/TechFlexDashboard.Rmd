---
title: "Earnings Season Analysis"
author: ""
output: 
  flexdashboard::flex_dashboard:
    social: menu
    theme: cerulean
runtime: shiny
---

```{r setup, include=FALSE}
library(ggplot2)
library(plyr)
library(XML)
library(flexdashboard)
library(tidyquant)
library(shiny)
library(TTR)
library(quantmod)
library(data.table)
library(rlist)
library(htmlTable)
library(RCurl)
library(plotly)
library(parallel)
library(xts)
source('EarningsDataExtraction.R')
#source('OptionScreeners.R')
source('Utilities.R')
source("HistoricalSectorReturns.R")
options("getSymbols.warning4.0"=FALSE)

```

```{r DataGeneration, include=FALSE, eval= T}
# Run the script to find the companies reporting earnings this month. 
# Then pick a sector and display the data accordingly for it. 
startDate = Sys.Date() -90
endDate = ceiling_date(Sys.Date(), "month") - days(1)
dates = seq(startDate,by = 'day',to = endDate)

# weeklyPerf = lapply(dates, FetchEarningsReleaseList)
# weeklyData = rbindlist(weeklyPerf)
# saveRDS(weeklyData,"weeklyData.rds")
weeklyData = readRDS("weeklyData.rds")
weeklyData$EarningsDate <- as.Date(weeklyData$EarningsDate)
weeklyData = weeklyData %>% filter(!is.na(Sector))

histData = weeklyData %>% filter(EarningsDate < Sys.Date())
weeklyData = weeklyData %>% filter(EarningsDate >= Sys.Date())
sectors= unique(weeklyData$Sector)
## Sector Performance 
mktSymbols = c('SPY', 'XLK', "XLB","XLY","XLP","XLRE","XLI", "XLV","XLU","XLE","XLF")
sectorETFs = c('SP500',"Technology","Materials", "Consumer Discretionary","Consumer Staples", "Real Estate","Industrial", "Health Care" ,"Utilities" ,"Energy" ,"Financials")

sectorPrices =  suppressWarnings(lapply(mktSymbols, function(x) getSymbols(Symbols = x,
                                                                           from = startDate - months(12),
                                                                           to = endDate,
                                                                           auto.assign = F)[,6]))
# saveRDS(sectorPrices,"sectorPrices.rds")
# sectorPrices = readRDS("sectorPrices.rds")

monthRetS  =  sapply(sectorPrices,function(x)tail(round(monthlyReturn(x)*100,2),1))
weeklyRetS =  sapply(sectorPrices,function(x)tail(round(weeklyReturn(x)*100,2),1))
dailyRetS  =  sapply(sectorPrices,function(x)tail(round(dailyReturn(x)*100,2),1))

retDataETF = cbind.data.frame(SectorETF = sectorETFs,
                              DailyReturn = dailyRetS,
                              WeeklyReturns = weeklyRetS,
                              MonthlyReturn=  monthRetS
)

retDataETF = melt(retDataETF, id.vars ='SectorETF')


```

```{r TechIndicatorsCalculations}
symbols = as.character(weeklyData$Symbol)
priceData =  suppressWarnings(lapply(symbols, function(x) getSymbols(Symbols = x,
                                                                     from = startDate - months(12),
                                                                     to = endDate,
                                                                     auto.assign = F)[,6]))
# saveRDS(priceData,"priceData.rds")
# priceData = readRDS("priceData.rds")
weeklyData = as.data.table(weeklyData)
weeklyData[, priceData := list(priceData)]
weeklyData[,':='(lengthCount = lapply(priceData, nrow),
                 naCount   = lapply(priceData, function(x)sum(is.na(x)))
)]

weeklyData = weeklyData[naCount == 0][lengthCount > 200]
priceDataN = weeklyData$priceData

monthRet  =  sapply(priceDataN,function(x)tail(round(monthlyReturn(x)*100,2),1))
weeklyRet =  sapply(priceDataN,function(x)tail(round(weeklyReturn(x)*100,2),1))
dailyRet  =  sapply(priceDataN,function(x)tail(round(dailyReturn(x)*100,2),1))
closingPrice = sapply(priceDataN, function(x)round(tail(x,1),2))
ma50 = sapply(priceDataN, function(x)round(tail(SMA(x, n = 50),1),2))
ma200 = sapply(priceDataN, function(x)round(tail(SMA(x, n = 200),1)))

rsi = sapply(priceDataN, function(x)tail(RSI(x, n =14),1))
rsiRange = c(0, 30, 50, 70, 100)
rsiMeaning= c('OverSold','NearingOversold', 'NearingOverbought','Overbought')
rsiD = rsiMeaning[findInterval(rsi, rsiRange)]


allData = cbind.data.frame(Symbol  =  weeklyData$Symbol,
                           Company = weeklyData$Company,
                           Sector  =  weeklyData$Sector,
                           Mcap= weeklyData$Mcap,
                           MonthlyRet = monthRet, 
                           WeeklyRet = weeklyRet, 
                           DailyRet = dailyRet, 
                           ClosingPrice = closingPrice,
                           MA50 = ma50,
                           MA200 = ma200, 
                           RSI = rsiD,
                           EarningsDate = weeklyData$EarningsDate)



```


Upcoming Earnings 
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------
```{r}
selectInput("Sector", label = "Sector:",
            choices = sectors)

```

The dashboard is designed to provide information regarding upcoming earnings of the public companies.
This information should help investors / traders to make short term plays around the earnings date.

This section shows basic info for companies expected to report earnings this month. 
The sector filter is provided above for analysis. 



NOTE: The list shown here is not dynamic and updated every month. Right now the data corresponds to all expected earnings releases till end of May.However, other sections regarding return analysis are updated everyday dynamicallly. 



Column
-----------------------------------------------------------------------

### Returns Data

```{r}
DT::renderDataTable({
  weeklyData %>% filter(Sector == as.character(input$Sector) & EarningsDate >= Sys.Date() ) %>% 
    select(Symbol, 
           Company, 
           Sector, 
           Mcap,
           EPS_Est, 
           EPS_Surp, 
           EPS_Reported, 
           EarningsDate)
})
```


Technical Data 
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------
```{r}
selectInput("Sector2", label = "Sector:",
            choices = sectors)
```
This section displays basic return performance of the individual securities. 

The second table displays some key technical indicators to assist in making trading decisions.


Row
-----------------------------------------------------------------------

### Technical Indicators


```{r}
DT::renderDataTable({ 
  allData %>% filter(Sector == as.character(input$Sector2) & EarningsDate >= Sys.Date()) %>% 
    select(Symbol,
           Company,
           Mcap,
           ClosingPrice,
           DailyRet,
           WeeklyRet,
           MonthlyRet,
           MA50,
           MA200,
           RSI)}, 
  width = 'auto' ,
  height ='auto', 
  options = list(pageLength = 10))

```



Sector Performance
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------
### Recent Performance of the Sectors

These charts help understand most recent market movements of differnt sectors, providing a high level market snapshot . Also to display market leaders and laggards.

```{r}
Ret = ifelse(retDataETF$value >0 ,"Positive", "Negative")
p1 = ggplot(retDataETF, aes(SectorETF, value , fill = Ret)) +
  geom_bar(stat ='identity') + coord_flip() + facet_wrap(~variable, ncol = 3) +
  scale_fill_manual(values = c('Positive' ='Dark Green', 'Negative' ='Red' )) + ylab('Returns') + xlab('Sectors') + 
  theme(legend.position='none')

ggplotly(p1)

```

### Historical Performance by Sector

This chart shows average monthly returns of each sector in each month. This helps understand the seasonality component of sector performance in the market.
```{r}

p1 = ggplot(temp, aes(x = months,y = AvgMonthlyRet, fill = retType)) + 
  geom_bar(stat = 'identity') +
  facet_wrap(~ variable, ncol = 4) + 
  scale_fill_manual(values = c('Positive' ='Dark Green', 'Negative' ='Red' )) +
  theme(legend.position='none') + xlab("") + 
  theme(axis.text.x = element_text(angle = 90))


ggplotly(p1)
```

### Historical Performance by Month

This chart provides insights regarding performance of each sector in different months in calender year. Its just another way to visualize the previous chart, but grouped by month instead of sector

```{r}

p1 = ggplot(temp, aes(x = variable,y = AvgMonthlyRet, fill = retType)) + 
  geom_bar(stat = 'identity') + 
  facet_wrap(~ months, ncol = 4) + coord_flip() +
  scale_fill_manual(values = c('Positive' ='Dark Green', 'Negative' ='Red' )) +
  theme(legend.position='none') + xlab("")

ggplotly(p1)
```

### Weighted Average Earnings Surpise by Sector( Last 90 days)

```{r}

histData$CapBreakdown =ifelse(histData$Mcap >=10000 ,'LargeCap',
                              ifelse(histData$Mcap >=2000, 'MidCap',
                                     'SmallCap'))

## Parsing numbers
histData$EPS_Surp = parse_number(histData$EPS_Surp)

sectorSurp = histData %>% group_by(Sector) %>% summarise(AvgSurp = weighted.mean(x = EPS_Surp,w = Mcap, na.rm = T))
sectorSurp = sectorSurp[complete.cases(sectorSurp),]
Esurp = ifelse(sectorSurp$AvgSurp > 0 , "Positive", "Negative")

p1 = ggplot(sectorSurp, aes(reorder(Sector, AvgSurp), AvgSurp,fill = Esurp )) +
  geom_bar(stat ='identity') + coord_flip() +
  scale_fill_manual(values = c('Positive' ='Dark Green', 'Negative' ='Red' )) + 
  ylab('Earnings Surprise in %' ) + xlab("")+
  theme(legend.position='none')

ggplotly(p1)
```

